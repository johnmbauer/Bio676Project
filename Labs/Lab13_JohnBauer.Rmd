---
title: "Lab13_JohnBauer"
author: "John Bauer"
date: "2024-04-17"
output: 
  html_document:
    toc: true
    toc_depth: 4
    Theme: yeti
    Highlight: haddock
    code_folding: hide
---


```{r}
library(tidyverse)
library(ggtree)
# added treeio and ggimage library
library(treeio)
library(ggimage)
library(rphylopic)

tree <- read.tree("data/lab13/tree_newick.nwk")
tree
```
## Basic Trees
```{r}
# build a ggplot with a geom_tree
ggplot(tree) + geom_tree() + theme_tree()
# This is convenient shorthand
ggtree(tree)
```
```{r}
# add a scale
ggtree(tree) + geom_treescale()
# or add the entire scale to the x axis with theme_tree2()
ggtree(tree) + theme_tree2()

ggtree(tree, branch.length="none")

ggtree(tree, branch.length="none", color="blue", size=2, linetype=3)
```

```{r}
ggtree(tree,branch.length="none",layout='circular')
```

```{r}
# create the basic plot
p <- ggtree(tree)
# add node points
p + geom_nodepoint()
# add tip points
p + geom_tippoint()
# Label the tips
p + geom_tiplab()
```

## Tree Annotation: Labeling, Highlights, Connecting Taxa

```{r}
ggtree(tree) + geom_text(aes(label=node), hjust=-.3)
```

```{r}
ggtree(tree) + geom_tiplab()
MRCA(tree, c("C", "E"))
MRCA(tree, c("G", "H"))
```

```{r}
ggtree(tree) + geom_cladelabel(node=17, label="Some random clade", color="red")
ggtree(tree) + geom_tiplab() + geom_cladelabel(node=17, label="Some random clade", color="red2", offset=.8)

ggtree(tree) + geom_tiplab() + geom_cladelabel(node=17, label="Some random clade", color="red2", offset=.8) + geom_cladelabel(node=21, label="A different clade", color="blue", offset=.8)

ggtree(tree) + geom_tiplab() + geom_cladelabel(node=17, label="Some random clade", color="red2", offset=.8, align=TRUE) + geom_cladelabel(node=21, label="A different clade", color="blue", offset=.8, align=TRUE) + theme_tree2() + xlim(0, 80) + theme_tree()

ggtree(tree) + geom_tiplab() + geom_hilight(node=17, fill="gold") + geom_hilight(node=21, fill="purple")

ggtree(tree) + geom_tiplab() + geom_taxalink("E", "H", color="blue3") + geom_taxalink("C", "G", color="orange2", curvature=-.9)
```

# Exercises

## Exercise 1

Look at the help again for ?ggtree, specifically at the layout= option. By default, it produces a rectangular layout.

    Create a slanted phylogenetic tree.
    Create a circular phylogenetic tree.
    Create a circular unscaled cladogram with thick red lines.

```{r}
ggtree(tree,layout='slanted')
ggtree(tree,layout='circular')
ggtree(tree,branch.length="none",layout='circular',color="red",size=5)
```

## Exercise 2

Similar to how we change the aesthetics for the tree inside the ggtree() call, we can also change the aesthetics of the points themselves by passing graphical parameters inside the geom_nodepoint() or geom_tippoint() calls. Create a phylogeny with the following aesthetic characteristics:

    tips labeled in purple
    purple-colored diamond-shape tip points (hint: Google search “R point characters”)
    large semitransparent yellow node points (hint: alpha=)
    Add a title with + ggtitle(...)
```{r}
ggtree(tree)+geom_tippoint(show.legend = FALSE,,pch=18,color="purple")+geom_tiplab(color="purple") +geom_nodepoint(color="yellow",alpha=0.5)+ggtitle("Colorful Tree")
```

## Exercise 3

Produce the figure below.

    First, find what the MRCA is for taxa B+C, and taxa L+J. You can do this in one of two ways:
        Easiest: use MRCA(tree, tip=c("taxon1", "taxon2")) for B/C and L/J separately.
        Alternatively: use ggtree(tree) + geom_text(aes(label=node), hjust=-.3) to see what the node labels are on the plot. You might also add tip labels here too.
    Draw the tree with ggtree(tree).
    Add tip labels.
    Highlight these clades with separate colors.
    Add a clade label to the larger superclade (node=17) that we saw before that includes A, B, C, D, and E. You’ll probably need an offset to get this looking right.
    Link taxa C to E, and G to J with a dashed gray line (hint: get the geom working first, then try changing the aesthetics. You’ll need linetype=2 somewhere in the geom_taxalink()).
    Add a scale bar to the bottom by changing the theme.
    Add a title.
    Optionally, go back to the original ggtree(tree, ...) call and change the layout to "circular".
```{r}

ggtree(tree) + geom_tiplab()+geom_hilight(node=MRCA(tree, c("B","C")), fill="purple") + geom_hilight(node=MRCA(tree, c("L","J")), fill="yellow") + geom_cladelabel(node=17, label = "Superclade 17", color="red", offset=2) + geom_taxalink("C", "E", color="grey",linetype=2) +geom_taxalink("G", "J", color="grey",linetype=2) + theme_tree2() + xlim(0, 80) + ggtitle("Exercise 3")
```


# Advanced tree annotation
```{r, fig.height=10}
# Read the data
tree <- read.beast("data/lab13/flu_tree_beast.tree")
# supply a most recent sampling date so you get the dates
# and add a scale bar
ggtree(tree, mrsd="2013-01-01") + 
  theme_tree2() 
# Finally, add tip labels and adjust axis
ggtree(tree, mrsd="2013-01-01") + 
  theme_tree2() + 
  geom_tiplab(align=TRUE, linesize=.5) + 
  xlim(1990, 2020)
```
```{r}
msaplot(p=ggtree(tree), fasta="data/lab13/flu_aasequence.fasta", window=c(150, 175))
msaplot(p=ggtree(tree), fasta="data/lab13/flu_aasequence.fasta", window=c(150, 175))+ coord_polar(theta="y")
```
```{r}
set.seed(42)
trees <- lapply(rep(c(10, 25, 50, 100), 3), rtree)
class(trees) <- "multiPhylo"
ggtree(trees) + facet_wrap(~.id, scale="free", ncol=4) + ggtitle("Many trees. Such phylogenetics. Wow.")
```

```{r}
# Generate a random tree with 30 tips
tree <- rtree(30)
# Make the original plot
p <- ggtree(tree)
# generate some random values for each tip label in the data
d1 <- data.frame(id=tree$tip.label, val=rnorm(30, sd=3))
# Make a second plot with the original, naming the new plot "dot", 
# using the data you just created, with a point geom.
p2 <- facet_plot(p, panel="dot", data=d1, geom=geom_point, aes(x=val), color='red3')
# Make some more data with another random value.
d2 <- data.frame(id=tree$tip.label, value = abs(rnorm(30, mean=100, sd=50)))
# Now add to that second plot, this time using the new d2 data above, 
# This time showing a bar segment, size 3, colored blue.
p3 <- facet_plot(p2, panel='bar', data=d2, geom=geom_segment, 
           aes(x=0, xend=value, y=y, yend=y), size=3, color='blue4') 
# Show all three plots with a scale
p3 + theme_tree2()
```

```{r}
# get phylopic 

newick <- "((Pongo_abelii,(Gorilla_gorilla_gorilla,(Pan_paniscus,Pan_troglodytes)Pan,Homo_sapiens)Homininae)Hominidae,Nomascus_leucogenys)Hominoidea;"

tree <- read.tree(text=newick)

d <- ggimage::phylopic_uid(tree$tip.label)
d$body_mass = c(52, 114, 47, 45, 58, 6)

p <- ggtree(tree) %<+% d + 
  geom_tiplab(aes(image=uid, colour=body_mass), geom="phylopic", offset=2.5) +
  geom_tiplab(aes(label=label), offset = .2) + xlim(NA, 7) +
  scale_color_viridis_c()
p  
```